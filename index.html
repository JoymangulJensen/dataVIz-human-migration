
<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>Home page</title>

    <!-- Bootstrap core CSS -->
    <link href="css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom styles for this template -->
    <link href="css/style.css" rel="stylesheet">

    <!-- Script for d3 js -->
    <script src="https://d3js.org/d3.v4.min.js"></script>
  </head>

  <body>

    <nav class="navbar navbar-expand-md navbar-dark fixed-top bg-dark">
      <a class="navbar-brand" href="#">Home</a>
      <a class="navbar-brand" href="#">Help</a>
      </button>
      
    </nav>
    <br/><br/><br/> 
    <main role="main">

      <div class="container">
        <!-- Example row of columns -->
        <div class="row">
          <div class="col-md-12">
            <div id="world_map_graph_d3">

            </div>
          </div>
        </div>

        <hr>

      </div> <!-- /container -->

    </main>

    <footer class="container">
      <p>&copy; Master 2 Data Science 2017</p>
    </footer>

   
    <script>
        var width = 960,
            height = 580,
            min_year = 2000,
            max_years = 2015,
            features,
            pib_by_country,
            migrations;

        var svg = d3.select( "#world_map_graph_d3" )
          .append( "svg" )
          .attr( "width", width )
          .attr( "height", height );

        var projection = d3.geoMercator()
          .scale(width / 2 / Math.PI)
          //.scale(100)
          .translate([width / 2, height / 2]);

        var path = d3.geoPath() // d3.geo.path avec d3 version 3
                    .projection(projection);

        d3.csv("data/pib_by_country.csv", function(data){
          pib_by_country = data;
        });

        

        d3.json("data/world.json", function(json) {
          d3.csv("data/migration_2000_2015.csv", function(data){
            migrations = data;
            features = json.features;
            init_pib();
            init_migration();
            svg.selectAll("path")
                .data(features)
                .enter()
                .append("path")
                .attr("d", path);
          });
        });

        function init_migration(){
          for(var i = 0; i < features.length; i++){

            var migration = {};
            var departure = {};
            var arrive = {};
            for(var y = min_year; y<=max_years; y++){
              departure[''+y] = new Array();
              arrive[''+y] = new Array();
            }
            migration.departure = departure;
            migration.arrive = arrive;
            features[i].migration = migration;
          }
          var indice_migration = 0;
          for(var i = 0; i < features.length; i++){
            while(migrations[indice_migration].CODECOUNTRY < features[i].id){
              indice_migration++;
            }
            console.log("-----------------------------------------------------");
            console.log(migrations[indice_migration].CODECOUNTRY);
            console.log(features[i].id);
            console.log(indice_migration);
            while(migrations[indice_migration].CODECOUNTRY == features[i].id){
              //Nous somme dans le cas ou nous avons trouvÃ© des elements je me suis compris c'est lessentiel ^^
              var migrate = {};
              migrate.dest = migrations[indice_migration].COU;
              migrate.value = migrations[indice_migration].Value;
              if(migrations[indice_migration].VAR == "INFLOW"){
                // Nous somme dans le cas de personne entrante (arrive)
                features[i].migration.arrive[''+migrations[indice_migration].YEAR].push(migrate);
              }else{
                // Nous somme dans le cas de personne partante (departure)
                features[i].migration.departure[''+migrations[indice_migration].YEAR].push(migrate);
              }
              indice_migration++;
            }
          }
          console.log(features);
        }

        function init_pib(){
          for(var i = 0; i < features.length; i++){
            var indice_country = pib_by_country.findIndex(p => p['Country Code'] == features[i].id);
            if(indice_country != -1){
              features[i].pib = pib_by_country[indice_country];
              features[i].pib.average = calculate_average_pib_between_years(min_year, max_years, pib_by_country[indice_country]);
            }else{
              var pib = {};
              pib.average = -1;
              features[i].pib = pib;
            }
          }
        }

        function update_pib(first_years, last_years){
          for(var i = 0; i < features.length; i++){
            if(features[i].pib.average != -1){
              features[i].pib.average = calculate_average_pib_between_years(first_years, last_years, features[i].pib);
            }
          }
        }

        function calculate_average_pib_between_years(first_years, last_years, one_country_pib){
          var nb_annee = last_years-first_years+1;
          var somme = 0;
          for(var j = first_years; j <= last_years; j++){
            var value = parseFloat(one_country_pib[""+j]);
            if(value){
              somme += value;
            }else{
              nb_annee--;
            }
          }
          return (somme / nb_annee);
        }
  </script>

   <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <script src="js/bootstrap.min.js"></script>
    -->
  </body>
</html>
