
<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>World map !</title>

    <!-- Bootstrap core CSS -->
    <link href="css/bootstrap.min.css" rel="stylesheet">


    <!-- Custom styles for this template -->
    <link href="css/style.css" rel="stylesheet">

    <!-- Script for d3 js -->
    <script src="https://d3js.org/d3.v4.min.js"></script>


    <!-- Tooltip style -->
    <style>
        .hidden {
            display: none;
        }

        div.tooltip {
            color: #222;
            background-color: #fff;
            padding: .5em;
            text-shadow: #f5f5f5 0 1px 0;
            border-radius: 2px;
            opacity: 0.9;
            position: absolute;
        }
    </style>

    <!-- Double slider style -->
    <style>
        .ticks {
            font: 10px sans-serif;
        }

        .track,
        .track-inset,
        .track-overlay {
            stroke-linecap: round;
        }

        .track {
            stroke: #000;
            stroke-opacity: 0.3;
            stroke-width: 10px;
        }

        .track-inset {
            stroke: #ddd;
            stroke-width: 8px;
        }

        .track-overlay {
            pointer-events: stroke;
            stroke-width: 50px;
            stroke: transparent;
            cursor: crosshair;
        }

        .handle {
            fill: #fff;
            stroke: #000;
            stroke-opacity: 0.5;
            stroke-width: 1.25px;
        }
    </style>
    <style>
        h1 {
            text-align: center !important;
        }

        .arcs path {
            opacity: .5;
            pointer-events: none;
            fill: none;
        }
    </style>


</head>

<body>
    <!--<nav class="navbar navbar-expand-lg navbar-light bg-light"> 

        <a class="navbar-brand" href="#">Titre</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <ul class="navbar-nav">
            <li class="nav-item">
                <a class="nav-link" href="https://github.com/JoymangulJensen/dataVIz-human-migration">GitHub</a>
            </li>
            <li class="nav-item">
                <span class="nav-link" onclick="reset()">Reset</span>
            </li>
        </ul>
    </div>
            
    </nav>-->


    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
      <a class="navbar-brand" href="#">Migration flows</a>
      <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <ul class="navbar-nav mr-auto">
          <li class="nav-item">
            <a class="nav-link" href="https://github.com/JoymangulJensen/dataVIz-human-migration">GitHub</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href='#' onclick="reset()">Reset</a>
          </li>
        </ul>
        <form class="form-inline">
          <div class="form-row">
            <div class="col-4">
                <!---->
                <div><div id="slider_d3"></div></div>
            </div>
          </div>

          <div class="form-row align-items-center">
            <div class="col-4">
              <select class="form-control" onchange="display()" id="select_coloration">
                <option value="none" selected="">No coloration</option>
                <option value="GDP">GDP</option>
                <option value="migrant_ratio" onchange="displayRatio()">Migrant-ratio</option>
                <option value="arrived" ="displayArrive()">Arrived</option>
                <option value="departure" onchange="displayDeparture()">Departure</option>
              </select>
            </div>
          </div>
        </form>
      </div>
    </nav>



    

<form>
    
</form>



    <main role="main">

        <!--<div class="container">-->
            <!-- Example row of columns -->
            <div class="row">
                <div class="col-md-10">
                    <h1 id="map-title">Ceci est un titre</h1>
                </div>
            </div>
            <div class="row" >
                <div class="col-md-3 card" >
                    <div class="card-body">
                        <h2 class="card-title">Legend</h2>
                        <p class="card-text" id="legend_d3"></p>
                    </div>


                    <div ></div>
                </div>
                <div class="col-md-8">
                    <div class="pull pull-right" id="world_map_graph_d3"></div>
                </div>

            </div>

            <hr>

        </div>
        <!-- /container -->

    </main>

    <footer class="container">
        <p align="center">&copy; Master 2 Data Science 2017</p>
    </footer>


    <script>


        var width = 960, // 960,
            height = 600; //580;

        var MIN_YEAR = 2000,
            MAX_YEAR = 2015,
            min_selected_year = 2000,
            max_selected_year = 2015;

        var lowest_pib,
            highest_pib,
            lowest_ratio,
            highest_ratio,
            lowest_departure,
            highest_departure,
            lowest_arrive,
            highest_arrive;

        var map_data,
            pib_data,
            migration_data,
            country_draw;

        var country_selected;

        var rectangles_legende = new Array();
        var arrow_legende = new Array();

        // Shades of light blue to saturated blue.
        var shades_blue = ["#e6ecff", "#ccd9ff", "#b3c6ff", "#99b3ff", "#809fff", "#668cff", "#4d79ff", "#3366ff", "#1a53ff", "#0040ff", "#0039e6", "#0033cc", "#002db3", "#002699", "#002080", "#001a66", "#00134d", "#000d33"]
        // Shades of light green to saturated green.
        var shades_green = ["#e6ffe6", "#ccffcc", "#b3ffb3", "#99ff99", "#80ff80", "#66ff66", "#4dff4d", "#33ff33", "#1aff1a", "#00ff00", "#00e600", "#00cc00", "#00b300", "#009900", "#008000", "#006600", "#004d00", "#003300"]




        
       

        var svg = d3.select("#world_map_graph_d3")
            .append("svg")
            .attr("width", width)
            .attr("height", height);

        var svg_slider = d3.select("#slider_d3")
            .append("svg")
            .attr("width", 250)
            .attr("height", 50);

        var svg_legend = d3.select("#legend_d3")
            .append("svg")
            .attr("width", 200)
            .attr("height", 400);

        var map = svg.append('g')
            .attr("class", "map")
            .attr('transform', 'translate(0, 0)')

        var tooltip = d3.select('body').append('div')
            .attr('class', 'hidden tooltip');

        var tooltip_arrow = d3.select('body').append('div')
            .attr('class', 'hidden tooltip');

        var double_slider = svg_slider.append("g")
            .attr("class", "slider")
            .attr("transform", "translate(" + 10 + "," + 20 + ")");

        var arcs = map.append("g")
            .attr("class", "arcs");




        var projection = d3.geoMercator()
            .scale(width / 2 / Math.PI - 10)
            .translate([width / 2, height / 2]);

        var path = d3.geoPath() // d3.geo.path avec d3 version 3
            .projection(projection);

        var slider_width = 200,
            x_slider = d3.scaleLinear()
            .domain([MIN_YEAR, MAX_YEAR])
            .range([0, slider_width])
            .clamp(true);

        svg.call(d3.zoom()
            // no longer in d3 v4 - zoom initialises with zoomIdentity, so it's already at origin
            // .translate([0, 0]) 
            // .scale(1) 
            .scaleExtent([1, 8])
            .on("zoom", zoomed));

        var color = d3.scaleQuantize()
            .range(shades_green);



       

        double_slider.append("line")
            .attr("class", "track")
            .attr("x1", x_slider.range()[0])
            .attr("x2", x_slider.range()[1])
            .select(function() {
                return this.parentNode.appendChild(this.cloneNode(true));
            })
            .attr("class", "track-inset")
            .select(function() {
                return this.parentNode.appendChild(this.cloneNode(true));
            })
            .attr("class", "track-overlay")
            .call(d3.drag()
                .on("start.interrupt", function() {
                    double_slider.interrupt();
                })
                .on("start drag", function() {
                    var distance1 = Math.abs(x_slider.invert(handle1.attr("cx")) - x_slider.invert(d3.event.x))
                    var distance2 = Math.abs(x_slider.invert(handle2.attr("cx")) - x_slider.invert(d3.event.x))
                    if (distance1 < distance2) {
                        setHandle1(x_slider.invert(d3.event.x));
                    } else {
                        setHandle2(x_slider.invert(d3.event.x));
                    }
                }));

        double_slider.insert("g", ".track-overlay")
            .attr("class", "ticks")
            .attr("transform", "translate(0," + 18 + ")")
            .selectAll("text")
            .data(x_slider.ticks(10))
            .enter().append("text")
            .attr("x", x_slider)
            .attr("text-anchor", "middle")
            .style('fill', 'white')
            .text(function(d) {
                return d;
            });

        var handle1 = double_slider.insert("circle", ".track-overlay")
            .attr("class", "handle")
            .attr("cx", 0)
            .attr("r", 9)

        var handle2 = double_slider.insert("circle", ".track-overlay")
            .attr("class", "handle")
            .attr("cx", 0)
            .attr("r", 9);

        function setHandle1(h) {
            handle1.attr("cx", x_slider(Math.round(h)));
            var year = Math.round(h);
            if (min_selected_year != year) {
                min_selected_year = year;
                updateDate();
            }
        }

        function setHandle2(h) {
            handle2.attr("cx", x_slider(Math.round(h)));
            var year = Math.round(h);
            if (max_selected_year != year) {
                max_selected_year = year;
                updateDate();
            }
        }

        function getRange() {
            var valA = x_slider.invert(handle1.attr("cx"));
            var valB = x_slider.invert(handle2.attr("cx"));
            return [valA, valB];
        }

        function setRange(min_selected_year, max_selected_year) {
            setHandle1(min_selected_year);
            setHandle2(max_selected_year);
        }







        d3.csv("data/pib_by_country.csv", function(data) {
            pib_data = data;
        });

        d3.json("data/world.json", function(json) {
            d3.csv("data/migration_2000_2015.csv", function(data) {
                migration_data = data;
                map_data = json.features; // list of all countries : {id: "AFG", migration: {…}, pib: {..}}

                // Init.
                feedPibData();
                feedMigrationData();
                setRange(MIN_YEAR, MAX_YEAR);
                feedSelectedMigrationData();
                feedSelectedAveragePib();

                country_draw = map.selectAll("path")
                    .data(map_data).enter()
                    .append("path")
                    .attr("d", path)
                    .style("fill", "#ccc") // At the start, display nothing (for the moment)
                    .on('mousemove', function(country) {
                        var mouse = d3.mouse(map.node()).map(function(country) {
                            return parseInt(country);
                        });

                        tooltip
                            .classed('hidden', false)
                            .attr('style', 'left:' + (mouse[0] + 50) + 'px; top:' + (mouse[1] + 0) + 'px')
                            .html(function() {
                                if (country.properties.name) {
                                    return country.properties.name +
                                        "<br> Selected years: " + country.migration.min_selected_year + "-" + country.migration.max_selected_year +
                                        "<br> GDP: " + roundNumber(country.pib.average) +
                                        "<br> Inflow: " + roundNumber(country.migration.arrive.somme) +
                                        "<br> Outlow: " + roundNumber(country.migration.departure.somme) +
                                        "<br> Ratio: " + roundNumber(country.migration.ratio);
                                } else {
                                    return "Unknown country.<br>Look at the console (F12)";
                                }
                            })

                    })
                    .on('mouseout', function() {
                        tooltip.classed('hidden', true);
                    })
                    .on('click', function(country) { // Click on a country to see migration.
                        country_selected = country;
                        firstDisplayLegendArrow();
                        display();
                    });
            });
        });


        firstDisplayLegendColoration();





        function display() {
            if(country_selected){
              displayArcs();
            }

            switch(document.getElementById("select_coloration").value) {
                case "none":
                    displayGrey()
                    break;
                case "GDP":
                    displayPib();
                    break;
                case "migrant_ratio":
                    displayRatio()
                    break;
                case "arrived":
                    displayArrive();
                    break;
                case "departure":
                    displayDeparture()
                    break;
                default:
                    displayGrey()
            }
        }

        function displayGrey(){
            country_draw.style("fill", "#ccc");
            clearLegendColoration();
        }

        // Draw PIB colors and legend.
        function displayPib() {
            color = d3.scaleQuantize()
                    .range(shades_blue)
                    .domain([lowest_pib, highest_pib]);
            country_draw.style("fill", function(d) {
                var pib = d.pib.average;
                if (( country_selected && (( country_selected.migration.arrive.sommes[d.id] ) || country_selected.migration.departure.sommes[d.id] ) || !country_selected ) && pib )  {
                    return color(pib);
                } else {
                    return "#ccc"; // #ccc = "grey"
                }
            });
            modifyLegendColoration(document.getElementById("select_coloration").value);
        }

        // Draw Migrant-ratio colors and legend.
        function displayRatio() {
            color = d3.scaleQuantize()
                    .range(shades_green)
                    .domain([lowest_ratio, highest_ratio/20]);
            country_draw.style("fill", function(d) {
                var ratio = d.migration.ratio;
                if ((country_selected && ((country_selected.migration.arrive.sommes[d.id])||country_selected.migration.departure.sommes[d.id]) || !country_selected)&&ratio) {
                    return color(ratio);
                } else {
                    return "#ccc"; // #ccc = "grey"
                }
            })
            modifyLegendColoration(document.getElementById("select_coloration").value);
        }

        // Draw Migrant-arrival colors and legend.
        function displayArrive() {

          color = d3.scaleQuantize()
              .range(shades_green)
              .domain([lowest_arrive, highest_arrive/5]);

          country_draw.style("fill", function(d) {
              var migration_number = d.migration.departure.somme;
              if (( country_selected && ((country_selected.migration.arrive.sommes[d.id])||country_selected.migration.departure.sommes[d.id]) || !country_selected) && migration_number) {
                  return color(migration_number);
              } else {
                  return "#ccc";
              }
          });
          modifyLegendColoration(document.getElementById("select_coloration").value);
        }

        // Draw Migrant-departure colors and legend.
        function displayDeparture() {

          color = d3.scaleQuantize()
              .range(shades_green)
              .domain([lowest_departure, highest_departure/5]);

            country_draw.style("fill", function(d) {
                var migration_number = d.migration.departure.somme;
                if (( country_selected && ((country_selected.migration.arrive.sommes[d.id])||country_selected.migration.departure.sommes[d.id]) || !country_selected) && migration_number) {
                    return color(migration_number);
                } else {
                    return "#ccc";
                }
            });
            modifyLegendColoration(document.getElementById("select_coloration").value);
        }

        function displayArcs() {
            arcs.remove();
            arcs = map.append("g")
                .attr("class", "arcs");
            var source = path.centroid(country_selected);

            arcdata = new Array();
            for (var i = 0; i < map_data.length; i++) {
                if (country_selected.migration.departure.sommes['' + map_data[i].id]) {
                    var arc = {};
                    arc.source = source;
                    arc.target = path.centroid(map_data[i]);
                    arc.type = "outflow";
                    arc.size = Math.sqrt(country_selected.migration.departure.sommes['' + map_data[i].id]) / 25;
                    arcdata.push(arc);
                }
                if (country_selected.migration.arrive.sommes['' + map_data[i].id]) {
                    var arc = {};
                    arc.source = path.centroid(map_data[i]);
                    arc.target = source;
                    arc.type = "inflow";
                    arc.size = Math.sqrt(country_selected.migration.arrive.sommes['' + map_data[i].id]) / 25;
                    arcdata.push(arc);
                }

            }
            arcs.selectAll("path")
                .data(arcdata)
                .enter()
                .append("path")
                .style("stroke-width", function(d) {

                    return d.size;
                })
                .style("stroke", function(d) {
                    if (d.type == "inflow")
                        return "green";
                    else
                        return 'red';
                })
                .attr('d', function(d) {
                    bend = 1.2;
                    var dx = d['target'][0] - d['source'][0],
                        dy = d['target'][1] - d['source'][1],
                        dr = Math.sqrt(dx * dx + dy * dy) * bend;
                    return "M" + d['target'][0] + "," + d['target'][1] + "A" + dr + "," + dr + " 0 0,1 " + d['source'][0] + "," + d['source'][1];
                });

        }

        function lngLatToArc(d) {
            // If no bend is supplied, then do the plain square root
            bend = 1.2;
            // `d[sourceName]` and `d[targetname]` are arrays of `[lng, lat]`
            // Note, people often put these in lat then lng, but mathematically we want x then y which is `lng,lat`
            var sourceLngLat = d['source'],
                targetLngLat = d['target'];
            if (targetLngLat && sourceLngLat) {
                var sourceXY = projection(sourceLngLat),
                    targetXY = projection(targetLngLat);
                // Uncomment this for testing, useful to see if you have any null lng/lat values
                // if (!targetXY) console.log(d, targetLngLat, targetXY)
                var sourceX = sourceXY[0],
                    sourceY = sourceXY[1];
                var targetX = targetXY[0],
                    targetY = targetXY[1];
                var dx = targetX - sourceX,
                    dy = targetY - sourceY,
                    dr = Math.sqrt(dx * dx + dy * dy) * bend;
                // To avoid a whirlpool effect, make the bend direction consistent regardless of whether the source is east or west of the target
                var west_of_source = (targetX - sourceX) < 0;
                if (west_of_source) {
                    return "M" + targetX + "," + targetY + "A" + dr + "," + dr + " 0 0,1 " + sourceX + "," + sourceY;
                } else {
                    return "M0,0,l0,0z";
                }
            }
        }

        function updateDate() {
            feedPibData();
            feedMigrationData();
            feedSelectedMigrationData();
            feedSelectedAveragePib();
            
            switch(document.getElementById("select_coloration").value) {
                case "none":
                    break;
                default:
                    modifyLegendColoration(document.getElementById("select_coloration").value);
            }

            display();
        }

        function reset() {
            // Init.
            feedPibData();
            feedMigrationData();
            setRange(MIN_YEAR, MAX_YEAR);
            feedSelectedMigrationData();
            feedSelectedAveragePib();

            country_selected = null;
            country_draw.style("fill", "#ccc");
            arcs.remove();
            clearLegend();
        }


        // Gather all migration data from migration_data and feed it into map_data.
        function feedMigrationData() {
            for (var i = 0; i < map_data.length; i++) {
                var migration = {};
                var departure = {};
                var arrive = {};
                for (var y = MIN_YEAR; y <= MAX_YEAR; y++) {
                    departure['' + y] = new Array();
                    arrive['' + y] = new Array();
                }
                departure['somme'] = new Array();
                arrive['somme'] = new Array();
                migration.departure = departure;
                migration.arrive = arrive;
                map_data[i].migration = migration;
            }

            var migrations_pointer = 0; // pointer for the migration_data file.

            for (var i = 0; i < map_data.length; i++) {

                // Move the pointer just before the 1st relevant line.
                while (migration_data[migrations_pointer].CODECOUNTRY < map_data[i].id) {
                    migrations_pointer++;
                }

                // For all relevant lines, do something.
                while (migration_data[migrations_pointer].CODECOUNTRY == map_data[i].id) {
                    var migrate = {};
                    migrate.dest = migration_data[migrations_pointer].COU;
                    migrate.value = migration_data[migrations_pointer].Value;
                    if (migration_data[migrations_pointer].VAR == "INFLOW") {
                        // Nous sommes dans le cas de personnes entrantes.
                        map_data[i].migration.arrive['' + migration_data[migrations_pointer].YEAR].push(migrate);
                    } else {
                        // Nous sommes dans le cas de personnes partantes.
                        map_data[i].migration.departure['' + migration_data[migrations_pointer].YEAR].push(migrate);
                    }

                    // If migrations_pointer = migration_data.length - 1 : break loop.
                    if (migration_data[migrations_pointer + 1] === undefined) {
                        break;
                    } else {
                        migrations_pointer++; // Else, increment pointer.
                    }
                }
            }
        }



        /* This function calculate the inflow and outflow of migrants
        between two date and save it in a table. For each row you have the sum.
        For example : 
          map_data[i].migration.departure.sommes['AZE'] = 
                sum(map_data[i].migration.departure.years where dest = 'AZE') 
          map_data[i].migration.departure.somme = 
                sum(sommes)
          map_data[i].migration.ratio = 
                map_data[i].migration.arrive.somme / map_data[i].migration.departure.somme
        */
        function feedSelectedMigrationData() {
            highest_ratio = -100000;
            lowest_ratio = +100000;
            highest_arrive = -100000;
            lowest_arrive = 100000000000;
            highest_departure = -10000000;
            lowest_departure = 10000000000;

            for (var i = 0; i < map_data.length; i++) { // Pour chaque pays
                var sums_arrive = {},
                    sums_departure = {};
                var sum_arrive = 0,
                    sum_departure = 0;
                for (var y = min_selected_year; y <= max_selected_year; y++) { // Pour chaque année de l'intervalle
                    for (var x = 0; x < map_data[i].migration.arrive['' + y].length; x++) {
                        var val_arrive = parseInt((map_data[i].migration.arrive['' + y])[x].value);
                        sum_arrive += val_arrive;
                        if (sums_arrive[(map_data[i].migration.arrive['' + y])[x].dest]) {
                            sums_arrive[(map_data[i].migration.arrive['' + y])[x].dest] += val_arrive;
                        } else {
                            sums_arrive[(map_data[i].migration.arrive['' + y])[x].dest] = val_arrive;
                        }
                    }
                    for (var x = 0; x < map_data[i].migration.departure['' + y].length; x++) {
                        var val_departure = parseInt((map_data[i].migration.departure['' + y])[x].value);
                        sum_departure += val_departure;
                        if (sums_departure[(map_data[i].migration.departure['' + y])[x].dest]) {
                            sums_departure[(map_data[i].migration.departure['' + y])[x].dest] += val_departure;
                        } else {
                            sums_departure[(map_data[i].migration.departure['' + y])[x].dest] = val_departure;
                        }
                    }
                }

                map_data[i].migration.departure.sommes = sums_departure;
                map_data[i].migration.departure.somme = sum_departure;
                map_data[i].migration.arrive.sommes = sums_arrive;
                map_data[i].migration.arrive.somme = sum_arrive;
                map_data[i].migration.min_selected_year = min_selected_year;
                map_data[i].migration.max_selected_year = max_selected_year;


                var ratio = sum_arrive / sum_departure;
                if (ratio > 100) ratio = 100;
                map_data[i].migration.ratio = ratio;
                updateExtremaRatio(ratio);
                updateExtremaArrive(sum_arrive);
                updateExtremaDeparture(sum_departure);
            }
        }

        // Update max or min migrant ratio **if needed**.
        function updateExtremaRatio(val) {
            if (highest_ratio < val) {
                highest_ratio = val;
            }
            if (lowest_ratio > val) {
                lowest_ratio = val;
            }
        }

        // Update max or min migrant ratio **if needed**.
        function updateExtremaArrive(val) {
            if (highest_arrive < val) {
                highest_arrive = val;
            }
            if (lowest_arrive > val) {
                lowest_arrive = val;
            }
        }

        // Update max or min migrant ratio **if needed**.
        function updateExtremaDeparture(val) {
            if (highest_departure < val) {
                highest_departure = val;
            }
            if (lowest_departure > val) {
                lowest_departure = val;
            }
        }

        // Gather all PIB from pib_data and feed it into map_data.
        function feedPibData() {
            lowest_pib = 10000000000;
            highest_pib = -10000000000;
            for (var i = 0; i < map_data.length; i++) {
                var indice_country = pib_data.findIndex(p => p['Country Code'] == map_data[i].id);
                if (indice_country != -1) {
                    map_data[i].pib = pib_data[indice_country];
                    map_data[i].pib.average = getAveragePib(min_selected_year, max_selected_year, pib_data[indice_country]);
                    updateExtremaPib(map_data[i].pib.average);
                } else {
                    var pib = {};
                    pib.average = -1;
                    map_data[i].pib = pib;
                }
            }
        }


        function feedSelectedAveragePib() {
            lowest_pib = 10000000000;
            highest_pib = -10000000000;
            for (var i = 0; i < map_data.length; i++) {
                if (map_data[i].pib.average != -1) {
                    map_data[i].pib.average = getAveragePib(min_selected_year, max_selected_year, map_data[i].pib);
                    updateExtremaPib(map_data[i].pib.average);
                }
            }
        }

        function getAveragePib(first_years, last_years, one_country_pib) {
            var nb_years = last_years - first_years + 1;
            var sum = 0;
            for (var j = first_years; j <= last_years; j++) {
                var value = parseFloat(one_country_pib["" + j]);
                if (value) {
                    sum += value;
                } else {
                    nb_years--;
                }
            }
            return (sum / nb_years);
        }

        // Update max or min PIB **if needed**.
        function updateExtremaPib(val) {
            if (highest_pib < val) {
                highest_pib = val;
            }
            if (lowest_pib > val) {
                lowest_pib = val;
            }
        }

        function roundNumber(n) {
            // Round number n to 2 decimals
            // If n > 1,000,000,000, return "1 Md"
            // Same for 1,000,000 and 1,000.

            if (n >= 1000000000) {
                n = Math.round(n * 100 / 1000000000) / 100;
                n = n + " Md";
            } else if (n >= 1000000) {
                n = Math.round(n * 100 / 1000000) / 100;
                n = n + " M";
            } else if (n >= 1000) {
                n = Math.round(n * 100 / 1000) / 100;
                n = n + " k";
            } else {
                n = Math.round(n * 100) / 100;
            }
            return n
        }


        function displayHelp() {
            var message = "Start: nothing. \n" +
                "Click on country: color show the importance of *inflow* in the country. \n" +
                "Click on PIB: obvious. \n" +
                "Click on ratio: show migration ratio (arrival/departures). \n TO BE UPDATED";
            alert(message);
        }

        function firstDisplayLegendColoration() {
            var title = svg_legend.append("text")
                .attr("x", 0)
                .attr("y", 20)
                .attr("font-size", "20px")
                .attr("fill", "black")
                .text("Coloration");
            rectangles_legende.push(title);
            var lowest = svg_legend.append("text") //Lowest (at the top)
                .attr("x", 30)
                .attr("y", 40)
                .attr("font-size", "15px")
                .attr("fill", "black")
                .text("");
            rectangles_legende.push(lowest);
            var highest = svg_legend.append("text") //Highest (at the bottom)
                .attr("x", 30)
                .attr("y", 40+10*shades_blue.length)
                .attr("font-size", "15px")
                .attr("fill", "black")
                .text("");
            rectangles_legende.push(highest);
            for (var i = 0; i < shades_blue.length; i++) {
                var rectangle = svg_legend.append("rect")
                    .attr("x", 0)
                    .attr("y", 10 * (i) + 30)
                    .attr("width", 20)
                    .attr("height", 20)
                    .style("fill", "#ccc");
                rectangles_legende.push(rectangle);
            }
        }

        function firstDisplayLegendArrow() {

            var text = svg_legend.append("text")
                .attr("x", 0)
                .attr("y", 10 * shades_blue.length + 70)
                .attr("font-size", "20px")
                .attr("fill", "red")
                .text("Outflow");
            arrow_legende.push(text);

            for (var i = 0; i < 3; i++) {
                if (i == 0) var val = 500;
                if (i == 1) var val = 10000;
                if (i == 2) var val = 500000;
                var arrow = svg_legend.append("line")
                    .attr("x1", 0)
                    .attr("y1", 10 * shades_blue.length + 80 + i * 20)
                    .attr("x2", 90)
                    .attr("y2", 10 * shades_blue.length + 80 + i * 20)
                    .attr("stroke-width", Math.sqrt(val) / 50)
                    .attr("stroke", "red")
                    .style('opacity', '0.5');
                var text = svg_legend.append("text")
                    .attr("x", 100)
                    .attr("y", 10 * shades_blue.length + 80 + i * 23)
                    .attr("font-size", "15px")
                    .attr("fill", "black")
                    .text("" + val);
                arrow_legende.push(arrow);
                arrow_legende.push(text);
            }


            var text = svg_legend.append("text")
                .attr("x", 0)
                .attr("y", 10 * shades_blue.length + 160)
                .attr("font-size", "20px")
                .attr("fill", "black")
                .text("Inflow");
            arrow_legende.push(text);

            for (var i = 0; i < 3; i++) {
                if (i == 0) var val = 500;
                if (i == 1) var val = 10000;
                if (i == 2) var val = 500000;
                var arrow = svg_legend.append("line")
                    .attr("x1", 0)
                    .attr("y1", 10 * shades_blue.length + 170 + i * 20)
                    .attr("x2", 90)
                    .attr("y2", 10 * shades_blue.length + 170 + i * 20)
                    .attr("stroke-width", Math.sqrt(val) / 50)
                    .attr("stroke", "green")
                    .style('opacity', '0.5');
                var text = svg_legend.append("text")
                    .attr("x", 100)
                    .attr("y", 10 * shades_blue.length + 170 + i * 23)
                    .attr("font-size", "15px")
                    .attr("fill", "black")
                    .text("" + val);
                arrow_legende.push(arrow);
                arrow_legende.push(text);
            }
        }

        function modifyLegendColoration(value) {

            switch(value) {
                case "none":
                    //Do nothing
                    fillRectangleLegendGrey();
                    break;
                case "GDP":
                    rectangles_legende[1].text(""+roundNumber(lowest_pib));
                    rectangles_legende[2].text(""+roundNumber(highest_pib));
                    fillRectangleLegend(shades_blue);
                    break;
                case "migrant_ratio":
                    rectangles_legende[1].text(""+roundNumber(lowest_ratio));
                    rectangles_legende[2].text(""+roundNumber(highest_ratio/*/20*/));
                    fillRectangleLegend(shades_green);
                    break;
                case "arrived":
                    rectangles_legende[1].text(""+roundNumber(lowest_arrive));
                    rectangles_legende[2].text(""+roundNumber(highest_arrive/*/5*/));
                    fillRectangleLegend(shades_green);
                    break;
                case "departure":
                    rectangles_legende[1].text(""+roundNumber(lowest_departure));
                    rectangles_legende[2].text(""+roundNumber(highest_departure/*/5*/));
                    fillRectangleLegend(shades_green);
                    break;
                default:
                    //Do nothing
                    fillRectangleLegendGrey();
                    break;
            }


            function fillRectangleLegend(shades){
                for (var i = 3; i < rectangles_legende.length; i++) {
                    rectangles_legende[i].style("fill", shades[i]);
                }
            }

            function fillRectangleLegendGrey(){
                for (var i = 3; i < rectangles_legende.length; i++) {
                    rectangles_legende[i].style("fill", "#ccc");
                }
            }
        }

        function clearLegendColoration() {
            for (var i = 0; i < rectangles_legende.length; i++) {
                rectangles_legende[i].remove();
            }
            rectangles_legende = new Array();
            firstDisplayLegendColoration();
        }

        function clearLegendArrow() {
            for (var i = 0; i < arrow_legende.length; i++) {
                arrow_legende[i].remove();
            }
        }

        function clearLegend() {
            clearLegendArrow();
            clearLegendColoration();
        }

        function zoomed() {
            map.style("stroke-width", 1.5 / d3.event.transform.k + "px");
            // g.attr("transform", "translate(" + d3.event.translate + ")scale(" + d3.event.scale + ")"); // not in d3 v4
            map.attr("transform", d3.event.transform); // updated for d3 v4
        }
    </script>

    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster-->
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.3/js/bootstrap.min.js" integrity="sha384-a5N7Y/aK3qNeh15eJKGWxsqtnX/wWdSZSKp+81YjTmS15nvnvxKHuzaWwXHDli+4" crossorigin="anonymous"></script>
    
</body>

</html>