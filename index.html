
<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>Home page</title>

    <!-- Bootstrap core CSS -->
    <link href="css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom styles for this template -->
    <link href="css/style.css" rel="stylesheet">

    <!-- Script for d3 js -->
    <script src="https://d3js.org/d3.v4.min.js"></script>

    <style>
    .hidden {
        display: none;
    }
    div.tooltip {
        color: #222;
        background-color: #fff;
        padding: .5em;
        text-shadow: #f5f5f5 0 1px 0;
        border-radius: 2px;
        opacity: 0.9;
        position: absolute;
       }


    </style>
  </head>

  <body>

    <nav class="navbar navbar-expand-md navbar-dark fixed-top bg-dark">
      <a class="navbar-brand" href="#">Home</a>
      <a class="navbar-brand" href="#">Help</a>
      <a onclick="reset()" class="navbar-brand" href="#">reset</a>
    </nav>
    <br/><br/><br/> 
    <main role="main">

      <div class="container">
        <!-- Example row of columns -->
        <div class="row">
          <div class="col-md-12">
            <div id="world_map_graph_d3">

            </div>
          </div>
        </div>

        <hr>

      </div> <!-- /container -->

    </main>

    <footer class="container">
      <p align="center">&copy; Master 2 Data Science 2017</p>
    </footer>

   
    <script>
        var width = 960,
            height = 580,
            min_year = 2000,
            max_year = 2015,
            min_selected_year = 2000,
            max_selected_year = 2015,
            features,
            pib_by_country,
            min_key_pib,
            max_key_pib,
            min_key_migrant,
            max_key_migrant,
            migrations,
            country_draw;


        var color = d3.scaleQuantize()
          .range(["#e6ffe6", "#ccffcc", "#b3ffb3", "#99ff99", "#80ff80", "#66ff66", "#4dff4d", "#33ff33", "#1aff1a", "#00ff00", "#00e600", "#00cc00", "#00b300", "#009900", "#008000", "#006600", "#004d00", "#003300"]);

        var svg = d3.select( "#world_map_graph_d3" )
          .append( "svg" )
          .attr( "width", width )
          .attr( "height", height );


        var tooltip = d3.select('body').append('div')
          .attr('class', 'hidden tooltip');


        var projection = d3.geoMercator()
          .scale(width / 2 / Math.PI)
          //.scale(100)
          .translate([width / 2, height / 2]);

        var path = d3.geoPath() // d3.geo.path avec d3 version 3
                     .projection(projection);

        d3.csv("data/pib_by_country.csv", function(data){
          pib_by_country = data;
        });
        
        d3.json("data/world.json", function(json) {
          d3.csv("data/migration_2000_2015.csv", function(data){
            migrations = data;
            features = json.features; // list of all countries : {id: "AFG", migration: {…}, pib: {..}}
            var test1,test2;
            init_pib();
            init_migration();
            calcule_nb_total_migrant_between(min_year, max_year);
            color.domain([min_key_migrant*0.5,max_key_migrant/25]);
            country_draw = svg.selectAll("path")
                .data(features)
                .enter()
                .append("path")
                .attr("d", path)
                .style("fill", function(d) {
                  //on prend la valeur recuperee plus haut
                  var value = d.migration.ratio;
                  if (value) {
                      return color(value);
                  } else {
                      // si pas de valeur alors en gris
                      return "#ccc";
                  }
                })
                .on('mousemove', function(country) {
                  var mouse = d3.mouse(svg.node()).map(function(country) {
                      return parseInt(country);
                  });

                  tooltip.classed('hidden', false)
                    .attr('style', 'left:' + (mouse[0]+195) + 'px; top:' + (mouse[1]+10) + 'px')
                  //console.log(country);
                  if (country.properties.name){
                        tooltip.html(country.properties.name + "<br> PIB : " + abbridgedNumber(country.pib.average) + 
                          "<br> Entrées : " + abbridgedNumber(country.migration.departure.somme) + 
                          "<br> Sorties : " + abbridgedNumber(country.migration.arrive.somme) + 
                          "<br> Ratio : " + abbridgedNumber(country.migration.ratio));
                  } else {
                        tooltip.html("Unknown country.<br>Look at the console (F12)");
                  }
                })
                .on('mouseout', function() {
                    tooltip.classed('hidden', true);
                })
                .on('click', function(country){
                  console.log(country);
                  change_coloration_to_pib();
                });
          });
        });

        function change_coloration_to_pib(){
          color = d3.scaleQuantize()
            .range(["#e6ecff", "#ccd9ff", "#b3c6ff", "#99b3ff", "#809fff", "#668cff", "#4d79ff", "#3366ff", "#1a53ff", "#0040ff", "#0039e6", "#0033cc", "#002db3", "#002699", "#002080", "#001a66", "#00134d", "#000d33"])
            .domain([min_key_pib*0.125,max_key_pib*0.125]);
          country_draw.style("fill", function(d) {
                  //on prend la valeur recuperee plus haut
                  var value = d.pib.average;
                  if (value) {
                      return color(value);
                  } else {
                      // si pas de valeur alors en gris
                      return "#ccc";
                  }
                });
        }

        function reset(){
          calcule_nb_total_migrant_between(min_year, max_year);
          min_selected_year = min_year;
          max_selected_year = max_year;
          color = d3.scaleQuantize()
            .range(["#e6ffe6", "#ccffcc", "#b3ffb3", "#99ff99", "#80ff80", "#66ff66", "#4dff4d", "#33ff33", "#1aff1a", "#00ff00", "#00e600", "#00cc00", "#00b300", "#009900", "#008000", "#006600", "#004d00", "#003300"])
            .domain([min_key_migrant*0.5,max_key_migrant/25]);
          country_draw.style("fill", function(d) {
                  //on prend la valeur recuperee plus haut
                  var value = d.migration.ratio;
                  if (value) {
                      return color(value);
                  } else {
                      // si pas de valeur alors en gris
                      return "#ccc";
                  }
                });
        }

        /* This function calculate the migrant and imigrant between two date and save it in a table. For each row you have the sum.
        exemple : features[i].migration.departure.sommes['AZE'] = sum(features[i].migration.departure.years where dest = 'AZE') 
        and features[i].migration.departure.somme = sum(sommes)
        and features[i].migration.ration = features[i].migration.arrive.somme / features[i].migration.departure.somme
        */
        function calcule_nb_total_migrant_between(min, max){
          max_key_migrant = -100000;
          min_key_migrant = 1000000;
          for(var i = 0; i < features.length; i++){// Pour chaque pays
            var sums_arrive = {}; 
            var sums_departure= {}; 
            var sum_arrive = 0;
            var sum_departure = 0;
            for (var y = min; y <= max; y++){// Pour chaque année de l'intervalle
              for(var x = 0; x < features[i].migration.arrive[''+y].length; x++){
                var val_arrive = parseInt((features[i].migration.arrive[''+y])[x].value);
                sum_arrive += val_arrive;
                if(sums_arrive[(features[i].migration.arrive[''+y])[x].dest]){
                  sums_arrive[(features[i].migration.arrive[''+y])[x].dest] += val_arrive;
                }else{
                  sums_arrive[(features[i].migration.arrive[''+y])[x].dest] = val_arrive;
                }
              }
              for(var x = 0; x < features[i].migration.departure[''+y].length; x++){
                var val_departure = parseInt((features[i].migration.departure[''+y])[x].value);
                sum_departure+=val_departure;
                if(sums_departure[(features[i].migration.departure[''+y])[x].dest]){
                  sums_departure[(features[i].migration.departure[''+y])[x].dest] += val_departure;
                }else{
                  sums_departure[(features[i].migration.departure[''+y])[x].dest] = val_departure;
                }
              }
            }
            features[i].migration.departure.sommes = sums_departure;
            features[i].migration.departure.somme = sum_departure;
            features[i].migration.arrive.sommes = sums_arrive;
            features[i].migration.arrive.somme = sum_arrive;
            features[i].migration.ratio = sum_arrive/sum_departure;
            min_max_key_migrant(sum_arrive/sum_departure);
          }
          console.log(min_key_migrant, max_key_migrant);
        }

        function min_max_key_migrant(val){
          if(max_key_migrant<val){
            max_key_migrant = val;
          }
          if(min_key_migrant>val){
            min_key_migrant = val;
          }
        }

        function min_max_key_pib(val){
          if(max_key_pib<val){
            max_key_pib = val;
          }
          if(min_key_pib>val){
            min_key_pib = val;
          }
        }

        function init_migration(){
          // For each country in the world (180), 
          // initialize 'migration' in 'features'.
          for (var i = 0; i < features.length; i++){

            var migration = {};
            var departure = {};
            var arrive = {};
            for (var y = min_year; y <= max_year; y++){
              departure[''+y] = new Array();
              arrive[''+y] = new Array();
            }
            departure['somme'] = new Array();
            arrive['somme'] = new Array();
            migration.departure = departure;
            migration.arrive = arrive;
            features[i].migration = migration;
          }

          var migrations_pointer = 0; // pointer for the migrations file.

          for(var i = 0; i < features.length; i++){

            // We move the pointer just before the 1st relevant line.
            while(migrations[migrations_pointer].CODECOUNTRY < features[i].id){
              migrations_pointer++;
            }
    
            // For all relevant lines, do something.
            while(migrations[migrations_pointer].CODECOUNTRY == features[i].id){
              var migrate = {};
              migrate.dest = migrations[migrations_pointer].COU;
              migrate.value = migrations[migrations_pointer].Value;
              if(migrations[migrations_pointer].VAR == "INFLOW"){
                // Nous sommes dans le cas de personnes entrantes.
                features[i].migration.arrive[''+migrations[migrations_pointer].YEAR].push(migrate);
              }else{
                // Nous sommes dans le cas de personnes partantes.
                features[i].migration.departure[''+migrations[migrations_pointer].YEAR].push(migrate);
              }

              // If migrations_pointer = migrations.length - 1 : break loop.
              if (migrations[migrations_pointer + 1] === undefined) { 
                break;
              } else {
                migrations_pointer++;  // Else, increment pointer.
              }
            } 
          }
        }

        function init_pib(){
          min_key_pib = 10000000000;
          max_key_pib = -10000000000;
          for(var i = 0; i < features.length; i++){
            var indice_country = pib_by_country.findIndex(p => p['Country Code'] == features[i].id);
            if(indice_country != -1){
              features[i].pib = pib_by_country[indice_country];
              features[i].pib.average = calculate_average_pib_between_years(min_year, max_year, pib_by_country[indice_country]);
              min_max_key_pib(features[i].pib.average);
            }else{
              var pib = {};
              pib.average = -1;
              features[i].pib = pib;
            }
          }
        }

        function update_pib(first_years, last_years){
          min_key_pib = 10000000000;
          max_key_pib = -10000000000;
          for(var i = 0; i < features.length; i++){
            if(features[i].pib.average != -1){
              features[i].pib.average = calculate_average_pib_between_years(first_years, last_years, features[i].pib);
              min_max_key_pib(features[i].pib.average);
            }
          }
        }

        function calculate_average_pib_between_years(first_years, last_years, one_country_pib){
          var nb_annee = last_years-first_years+1;
          var somme = 0;
          for(var j = first_years; j <= last_years; j++){
            var value = parseFloat(one_country_pib[""+j]);
            if(value){
              somme += value;
            }else{
              nb_annee--;
            }
          }
          return (somme / nb_annee);
        }



        // Utility functions
        function abbridgedNumber(n){
          // Round number n to 2 decimals
          // If n > 1,000,000,000, return "1 Md"
          // Same for 1,000,000 and 1,000.

          if (n >= 1000000000){
            n = Math.round(n * 100 /1000000000)/100
            n = n + " Md"
          }
          else if (n >= 1000000){
            n = Math.round(n*100/1000000)/100
            n = n + " M"
          }
          else if (n >= 1000){
            n = Math.round(n*100/1000)/100
            n = n + " k"
          }
          else {
            n = Math.round(n*100)/100
          }
          return n
        }



  </script>

   <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <script src="js/bootstrap.min.js"></script>
    -->
  </body>
</html>
